#!/bin/bash
GREP="grep -i"
export TEXTDOMAIN="termhelper"
export TEXTDOMAINDIR="/usr/share/locale"
MSG01="$(gettext -s "matches several subsections")"
MSG02="$(gettext -s "not found")"
MSG03="$(gettext -s "Hi! Today is")"
MSG04="$(gettext -s "Subsections")"

prefix=$(echo $LANG |cut -f1 -d _)
HELPDIR=/usr/share/termhelper/$prefix
[ -d ./$prefix ] && HELPDIR=./$prefix
STARTFILE=$(ls -1 $HELPDIR |grep -v '\.' |tail -n1)

find_help(){
	local pattern directsearch a block
	file="$STARTFILE"
	if ! [ "$1" ] ; then
		file=${HELPDIR}/$STARTFILE
		return 0
	fi
	pattern="^$(echo $@ |sed -e 's:\ :.\*\..*:g' -e 's/^/.*/' -e 's/$/.*/')$"
	directsearch=$(ls -1 $HELPDIR  |grep  "$pattern")
	if [ "$(echo $directsearch |wc -w)" -ne 1 ] ;then
		n=2
		echo -n "$STARTFILE"
		for a in $@ ; do
			unset block
			block=$(ls -1 $HELPDIR |grep $(basename $file) |awk -F. '{print $'$n'}' |$GREP $a |sort |uniq)
			if [ $(echo $block |wc -w) -eq 1 ] ; then
					file=${file}.$block
					echo -n " -> $block"
			elif [ $(echo $block |wc -w) -eq 0 ] ; then
				echo -e "\n\"$a\" $MSG02" >&2
				return 1
			else
				echo -e "\n\"$a\" - ${MSG01}:\n$block" >&2
				return 1
			fi
			n=$(( $n + 1))
		done
		echo ''
	else 	
		file=$directsearch
		echo $file |sed 's/\./ -> /g'
	fi
	file=${HELPDIR}/$file	
}

echo -e "${MSG03}: $(date +%A\ %e\ %b\ %Yr)"
echo -e \
■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■⌚$(date +%d.%m.%y)■
if find_help $@ ; then 
	source $file 2>/dev/null
echo -e \
■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■⌚$(date +%H:%M:%S)■
	subpart=$(ls -1 $HELPDIR |egrep $(basename $file)'\.[^\.]+*$' |sed 's/'$(basename $file).'//g')
	if [ -n "$subpart" ]  ;then
		echo -e "$MSG04 \"$(echo ${file} |sed -e 's:'${HELPDIR}/$STARTFILE'::' -e 's/^\.//')\":"
		echo $subpart |sed 's/\ /, /g'
		echo ''
	fi
else
	echo "Man:"
	man $1
fi
